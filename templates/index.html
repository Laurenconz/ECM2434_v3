<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/sustainability-bingo-logo.ico"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="theme-color" content="#000000"/>
    <meta name="description" content="Sustainability Bingo App"/>
    <link rel="apple-touch-icon" href="/static/sustainability bingo logo.jpeg"/>
    <link rel="manifest" href="/static/manifest.json"/>
    <title>Sustainability Bingo</title>
    
    <!-- Fix Functions Before React Loads -->
    <script>
        // Define these functions immediately, before any other scripts run
        console.log('Applying fixes before scripts load...');
        window.e = function() { return null; };
        window.n = function() { return null; };
        window.showNotification = function() {};
        window.showProgressUpdate = function() {};
        window.showTaskCompletion = function() {};
        window.showPatternCompletion = function() {};
        window.showPopup = function(options) {
            if (options && options.onConfirm) setTimeout(options.onConfirm, 100);
        };
    </script>
    
    <!-- Now load the main app script -->
    <script defer="defer" src="/static/js/main.b2233ee6.js"></script>
    <link href="/static/css/main.ebfb8bca.css" rel="stylesheet">
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- Comprehensive fix script -->
    <script>
        // Comprehensive fetch override
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            console.log('Fetch called with URL:', url);
            
            // Fix any hardcoded URLs
            if (typeof url === 'string') {
                if (url.includes('localhost:8000')) {
                    url = url.replace('localhost:8000', '');
                    console.log('Fixed localhost URL to:', url);
                }
                if (url.includes('https://ecm2434-v3.onrender.com')) {
                    url = url.replace('https://ecm2434-v3.onrender.com', '');
                    console.log('Fixed render URL from', url);
                }
            }
            
            console.log('Final URL being fetched:', url);
            return originalFetch(url, options);
        };
        
        // Patch XMLHttpRequest (used by Axios)
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
            console.log('XHR open called with URL:', url);
            
            // Fix any hardcoded URLs
            let newUrl = url;
            if (typeof url === 'string') {
                if (url.includes('localhost:8000')) {
                    newUrl = url.replace('localhost:8000', '');
                    console.log('Fixed localhost XHR URL to:', newUrl);
                }
                if (url.includes('https://ecm2434-v3.onrender.com')) {
                    newUrl = url.replace('https://ecm2434-v3.onrender.com', '');
                    console.log('Fixed render XHR URL to:', newUrl);
                }
            }
            
            console.log('Final XHR URL being requested:', newUrl);
            return originalOpen.call(this, method, newUrl, async, user, password);
        };

        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - setting up testing tools...');
            
            // Create a test function for direct API access
            window.testAPI = function() {
                console.log('Fetching leaderboard with fetch...');
                fetch('/api/leaderboard/')
                    .then(r => r.text())
                    .then(text => {
                        console.log('Raw response:', text);
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('Failed to parse JSON:', e);
                            console.log('Text was:', text);
                            throw e;
                        }
                    })
                    .then(data => {
                        console.log('Leaderboard data:', data);
                        alert('API test successful!');
                    })
                    .catch(err => {
                        console.error('API test failed:', err);
                        alert('API test failed: ' + err.message);
                    });
            };
            
            // Create a test button
            const btn = document.createElement('button');
            btn.textContent = 'Test API';
            btn.style.position = 'fixed';
            btn.style.top = '10px';
            btn.style.right = '10px';
            btn.style.zIndex = '9999';
            btn.style.padding = '8px 12px';
            btn.style.backgroundColor = '#4CAF50';
            btn.style.color = 'white';
            btn.style.border = 'none';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.onclick = window.testAPI;
            document.body.appendChild(btn);
            
            // Fix image loading errors
            document.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    console.log('Image load error, using fallback for:', e.target.src);
                    e.target.src = '/static/default.png';
                    e.preventDefault();
                }
            }, true);
            
            // Auto-test the API after a short delay
            setTimeout(function() {
                console.log("Auto-testing API...");
                window.testAPI();
            }, 2000);
            
            console.log('All fixes and testing tools applied!');
        });
    </script>
</body>
</html>